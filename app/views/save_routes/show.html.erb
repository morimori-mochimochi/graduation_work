<div class="container cute-title mx-auto px-4 py-8">
  <div class="flex justify-between items-center md-6">
    <h1 class="text-2xl font-bold"><%= @save_route.name %>の詳細</h1>
  </div>

  <div class="card bg-base-100 shadow-xl">
    <div class="card-body">
      <div class="space-y-2">

        <% if @save_route.execution_date.present? %>
          <p><strong>実行日:</strong> <%= @save_route.execution_date.strftime('%Y年%m月%d日') %></p>
        <% end %>

        <% if @save_route.travel_mode.present? %>
          <p><strong>移動手段:</strong>
            <%= case @save_route.travel_mode
                when 'driving' then '車'
                when 'walking' then '徒歩'
                end %>
          </p>
        <% end %>

        <% if @save_route.start_time.present? %>
          <p><strong>出発時刻:</strong> <%= @save_route.start_time.strftime('%H:%M') %></p>
        <% end %>

        <p><strong>出発点:</strong> <%= @save_route.start_point['name'] %></p>

        <% if @save_route.waypoints.present? %>
          <p><strong>経由地:</strong></p>
          <ul class="list-disc list-inside pl-4">
            <% @save_route.waypoints.each do |waypoint| %>
              <li>
                <%# dig: ネスト（入れ子）になったハッシュや配列から、安全かつ簡潔に値を取り出すためのメソッド %>
                <%= waypoint.dig('mainPoint', 'name') %>
                <% if waypoint['arrival_time'].present? %>
                  <span class="text-sm text-gray-500 ml-2"><%= Time.parse(waypoint['arrival_time']).in_time_zone('Tokyo').strftime('%H:%M') %>頃着</span>
                <% end %>
                <% if waypoint['stayDuration'].present? && (formatted_duration = SaveRoute.format_duration(waypoint['stayDuration'])).present? %>
                  <span class="text-sm text-gray-500 ml-2">(滞在: <%= formatted_duration %>)</span>
                <% end %>
                <% if waypoint['parkingLot'].present? %>
                  <span class="text-sm text-gray-500 ml-2">(P: <%= waypoint.dig('parkingLot', 'name') %>)</span>
                <% end %>
              </li>
            <% end %>
          </ul>
        <% end %>

        <p><strong>到着点:</strong>
          <%= @save_route.end_point.dig('mainPoint', 'name') %>
          <% if @save_route.end_point['arrival_time'].present? %>
            <span class="text-sm text-gray-500 ml-2"><%= Time.parse(@save_route.end_point['arrival_time']).in_time_zone('Tokyo').strftime('%H:%M') %>頃着</span>
          <% end %>
          <% if @save_route.end_point['parkingLot'].present? %>
            <span class="text-sm text-gray-500 ml-2">(P: <%= @save_route.end_point.dig('parkingLot', 'name') %>)</span>
          <% end %>
        </p>

        <% if @save_route.total_distance.present? %>
          <p><strong>総移動距離:</strong> <%= (@save_route.total_distance / 1000.0).round(2) %> km</p>
        <% end %>

        <% if @save_route.total_duration.present? %>
          <p><strong>所要時間:</strong> <%= (@save_route.total_duration / 60.0).ceil %> 分</p>
        <% end %>

      </div>
    </div>
  </div>
  <div id="route-data"
       data-route="<%= @save_route.to_json(only: [:travel_mode, :start_point, :end_point, :waypoints]) %>"
       style="display: none;">
  </div>
  <div id="map"></div>

  <div class="mt-6 flex items-center space-x-2">
    <%= link_to '編集', edit_save_route_path(@save_route), class: "btn-warning" %>
    <%= button_to '削除', @save_route, method: :delete, class: "btn btn-sm btn-error", form: { data: { turbo_confirm: '本当に削除しますか？', "barba-prevent": "all" } } %>
    <%= link_to '一覧へ', save_routes_path, class: "btn btn-ghost" %>
    <%= button_tag 'すぐ出発',
      # data属性:HTML要素に自由なデータを埋め込み、JavaScriptで使えるようにする仕組み
      id: 'start-navigation-from-saved-route',
      class: 'btn btn-primary',
      data: {
        route: @save_route.to_json(only: [:travel_mode, :start_point, :end_point, :waypoints]),
        car_navi_path: car_navigation_routes_path,
        walk_navi_path: walk_navigation_routes_path
      }
    %>
    <%# 実行日と出発時刻、そしてユーザーがLINE連携済みの場合のみタイマー設定ボタンを表示 %>
    <% if @save_route.execution_date.present? && @save_route.start_time.present? && current_user.line_connected? %>
      <%= button_to 'LINE通知', save_route_notifications_path(@save_route), method: :post, class: "btn btn-info", form: { data: { turbo_confirm: "出発5分前にLINE通知を設定します。よろしいですか？" } } %>
    <% end %>

    <%# LINE未連携の場合のみ連携ボタンを表示 %>
    <% unless current_user.line_messaging_user_id.present? %>
      <%= link_to 'LINE連携', new_api_v1_line_linkage_path, class: "btn btn-success", data: { turbo: false } %>
    <% end %>
  </div>
</div>
