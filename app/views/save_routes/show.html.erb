<%# JSONデータは複数回使用するため、変数に格納して再利用（パフォーマンス改善） %>
<% route_json = @save_route.to_json(only: [:travel_mode, :start_point, :end_point, :waypoints]) %>

<div class="container cute-title mx-auto px-4 py-8">
  <div class="flex justify-between items-center md-6">
    <h1 class="text-2xl font-bold"><%= @save_route.name %>の詳細</h1>
  </div>

  <div class="card bg-base-100 shadow-xl">
    <div class="card-body">
      <div class="space-y-2">

        <% if @save_route.execution_date.present? %>
          <p><strong>実行日:</strong> <%= @save_route.formatted_execution_date %></p>
        <% end %>

        <% if @save_route.travel_mode.present? %>
          <p><strong>移動手段:</strong> <%= @save_route.travel_mode_ja %></p>
        <% end %>

        <% if @save_route.start_time.present? %>
          <p><strong>出発時刻:</strong> <%= @save_route.formatted_start_time %></p>
        <% end %>

        <p><strong>出発点:</strong> <%= @save_route.start_point['name'] %></p>

        <% if @save_route.waypoints.present? %>
          <p><strong>経由地:</strong></p>
          <ul class="list-disc list-inside pl-4">
            <% @save_route.waypoints.each do |waypoint| %>
              <li>
                <%# dig: ネスト（入れ子）になったハッシュや配列から、安全かつ簡潔に値を取り出すためのメソッド %>
                <%= waypoint.dig('mainPoint', 'name') %>
                <% if waypoint['arrival_time'].present? %>
                  <span class="text-sm text-gray-500 ml-2"><%= Time.parse(waypoint['arrival_time']).in_time_zone('Tokyo').strftime('%H:%M') %>頃着</span>
                <% end %>
                <% if waypoint['stayDuration'].present? && (formatted_duration = SaveRoute.format_duration(waypoint['stayDuration'])).present? %>
                  <span class="text-sm text-gray-500 ml-2">(滞在: <%= formatted_duration %>)</span>
                <% end %>
                <% if waypoint['parkingLot'].present? %>
                  <span class="text-sm text-gray-500 ml-2">(P: <%= waypoint.dig('parkingLot', 'name') %>)</span>
                <% end %>
              </li>
            <% end %>
          </ul>
        <% end %>

        <p><strong>到着点:</strong>
          <%= @save_route.end_point.dig('mainPoint', 'name') %>
          <% if @save_route.end_point['arrival_time'].present? %>
            <span class="text-sm text-gray-500 ml-2"><%= Time.parse(@save_route.end_point['arrival_time']).in_time_zone('Tokyo').strftime('%H:%M') %>頃着</span>
          <% end %>
          <% if @save_route.end_point['parkingLot'].present? %>
            <span class="text-sm text-gray-500 ml-2">(P: <%= @save_route.end_point.dig('parkingLot', 'name') %>)</span>
          <% end %>
        </p>

        <% if @save_route.total_distance.present? %>
          <p><strong>総移動距離:</strong> <%= @save_route.total_distance_km %> km</p>
        <% end %>

        <% if @save_route.total_duration.present? %>
          <p><strong>所要時間:</strong> <%= @save_route.total_duration_minutes %> 分</p>
        <% end %>

        <% if @notify_at.present? %>
          <p><strong>通知日時:</strong> <%= @notify_at.strftime('%Y年%m月%d日 %H:%M') %></p>
          <div class=" flex items-center space-x-5">
            <p><strong>通知先メールアドレス:</strong> <%= current_user.email %></p>
            <%= link_to edit_mypage_path do %>
              <%= image_tag "/images/user_edit.png", alt: "edit_mypage",class:"btn_effect h-17" %>
            <% end %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
  <div id="route-data"
       data-route="<%= route_json %>"
       style="display: none;">
  </div>
  <div id="map"></div>

  <div class="mt-6 flex items-center space-x-2">
    <%= link_to save_routes_path, class: "nav-link" do %>
      <%= image_tag "/images/return_before.png", alt: "return_map", class: "btn_effect h-17" %>
    <% end %> 

    <%= link_to edit_save_route_path(@save_route), class: "nav-link" do %>
      <%= image_tag "/images/edit.png", alt: "edit",class:"btn_effect h-17" %>
    <% end %>
    
    <%= button_to @save_route,
      method: :delete,
      form: { data: { turbo: true, turbo_confirm: '本当に削除しますか？' } },
      class: "nav-link" do %>
      <%= image_tag "/images/delete.png", alt: "destroy", class: "btn_effect h-17" %>
    <% end %>
 
    <%= button_tag(
      id: 'start-navigation-from-saved-route',
      class: 'nav-link',
      data: {
        route: route_json,
        car_navi_path: car_navigation_routes_path,
        walk_navi_path: walk_navigation_routes_path
      }
    ) do %>
      <%= image_tag "/images/startNavi.png", alt: "startNavi", class: "btn_effect h-17" %>
    <% end %>

    <%# 実行日と出発時刻が設定されている場合のみ通知設定ボタンを表示 %>
    <% if @save_route.execution_date.present? && @save_route.start_time.present? %>
      <%# 通知が既に設定されているかチェック %>
      <% if @notify_at.present? %>
        <%# 通知設定済み: ボタンを無効化し、薄く表示 %>
        <%= button_tag type: 'button', class: "nav-link", disabled: true, title: "通知は設定済みです" do %>
          <%= image_tag "/images/mail_notification.png", alt: "mail", class: "btn_effect h-17 opacity-50" %>
        <% end %>
      <% else %>
        <%# 通知設定可能: 通常のボタン %>
        <%= button_to save_route_notifications_path(@save_route),
          method: :post,
          form: { data: { turbo: true, turbo_confirm: "出発5分前にメールで通知を設定します。よろしいですか？" } },
          class: "nav-link" do %>
          <%= image_tag "/images/mail_notification.png", alt: "mail", class: "btn_effect h-17" %>
        <% end %>
      <% end %>
    <% else %>
      <%# 前提条件未達: ボタンを無効化し、アラートを表示 %>
      <%= button_tag type: 'button', class: "nav-link", onclick: "alert('通知を設定するには、編集画面で実行日と出発時刻を設定してください。')" do %>
        <%= image_tag "/images/mail_notification.png", alt: "mail", class: "btn_effect h-17 opacity-50" %>
      <% end %>
    <% end %>
  </div>
</div>
