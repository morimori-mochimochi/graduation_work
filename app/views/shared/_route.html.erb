<script>
  async function drawRoute(){
    await window.mapApiLoaded;

    // #まず現在地を取得
    navigator.geolocation.watchPosition((pos) =>{
      const currentPos = {
        lat: pos.coords.latitude,
        lng: pos.coords.longitude
      };
      window.currentPos = currentPos;

    // #DirectionsAPIで使うオブジェクトの生成
    const directionsService = new google.maps.DirectionsService();
    // #取得したルートをマップに表示
    const directionsRenderer = new google.maps.DirectionsRenderer();
    // #どのマップにルートを描画するかを指定
    directionsRenderer.setMap(window.map);

    console.log("ルート描画の準備ができました");

    directionsService.route(
      {
        origin: currentPos,
        destination: "浅草寺",
        waypoints: [
          { location: "上野駅", stopover: true },
          { location: "秋葉原駅", stopover: true }
        ],
        optimizeWaypoints: true,
        travelMode: google.maps.TravelMode.DRIVING
      },
      (response, status) => {
        if (status === "OK"){
          directionsRenderer.setDirections(response);
        } else {
          alert("ルートの取得に失敗しました: " + status);
        }
      }
    );
  }

  document.addEventListener("DOMContentLoaded", () => {
    const drawRouteBtn = document.getElementById("drawRoute");
    drawRouteBtn.addEventListener("click", () => {
      drawRoute();
    });
  });
</script>