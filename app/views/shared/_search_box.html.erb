<%= render 'shared/maps_ready' %>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const startBtn = document.getElementById("searchStartBtn");
    const startInput = document.getElementById("start_address");

    const destBtn = document.getElementById("searchDestBtn");
    const destInput = document.getElementById("destination_address");

    function setupSearch(btn, input) {
      if (!btn || !input) return;

      btn.addEventListener("click", async () => {
        await window.mapsReady;
        
        if (!window.map){
          alert("地図が読み込まれていません");
          return;
        }
       
        // #クリックで置いたマーカーの位置を検索の中心に  
        if (!window.searchCenter) {
          alert("まずマーカーを配置してください");
          return;
        }

        const center = window.searchCenter;
        const delta = 0.018;

        const query = input.value.trim();
        if (!query){
          alert("検索語を入力してください");
          return;
        }

        try{
          const {Place} = await google.maps.importLibrary("places");

          const request = {
            textQuery: query,
            locationBias: { 
              // #矩形の範囲で検索
              rectangle: {
                south: center.lat - delta,
                west: center.lng - delta,
                north: center.lat + delta,
                east: center.lng + delta
              }
            },
            fields: ["displayName","location","formattedAddress"]
          };
          const response = await Place.searchByText(request);
          // #既存のマーカーを消す処理
          if (window.markers) {
            window.markers.forEach(marker => marker.setMap(null));
          }
          window.markers = [];
        
          // #検索結果にマーカーを立てる  
          response.results.forEach(place => {
            const marker = new google.maps.Marker({
              map: window.map,
              position: place.location,
              title: (place.displayName && place.displayName.text) ? place.displayName.text : ""
            });
            window.markers = window.markers || [];
            // #作ったマーカーを配列window.markersに保存
            window.markers.push(marker);
          });
        } catch (error) {
          alert("検索に失敗しました: " + error.message);
        }
      });
    }
    
    setupSearch(startBtn, startInput);
    setupSearch(destBtn, destInput);
  });
</script>
